/*!
 * jQuery Selectbox plugin 0.2
 *
 * Copyright 2011-2012, Dimitar Ivanov (http://www.bulgaria-web-developers.com/projects/javascript/selectbox/)
 * Licensed under the MIT (http://www.opensource.org/licenses/mit-license.php) license.
 * 
 * Date: Tue Jul 17 19:58:36 2012 +0300
 */
(function(n,t){function f(){this._state=[],this._defaults={classHolder:"sbHolder",classHolderDisabled:"sbHolderDisabled",classSelector:"sbSelector",classOptions:"sbOptions",classGroup:"sbGroup",classSub:"sbSub",classDisabled:"sbDisabled",classToggleOpen:"sbToggleOpen",classToggle:"sbToggle",classFocus:"sbFocus",speed:200,effect:"slide",onChange:null,onOpen:null,onClose:null}}var r="selectbox",i=!1,u=!0;n.extend(f.prototype,{_isOpenSelectbox:function(n){if(!n)return i;var t=this._getInst(n);return t.isOpen},_isDisabledSelectbox:function(n){if(!n)return i;var t=this._getInst(n);return t.isDisabled},_attachSelectbox:function(t,f){function v(){var t,i,r=this.attr("id").split("_")[1];for(t in o._state)t!==r&&o._state.hasOwnProperty(t)&&(i=n("select[sb='"+t+"']")[0],i&&o._closeSelectbox(i))}function y(){var i=arguments[1]&&arguments[1].sub?!0:!1,r=arguments[1]&&arguments[1].disabled?!0:!1;arguments[0].each(function(f){var s=n(this),v=n("<li>"),h;s.is(":selected")&&(l.text(s.text()),w=u),f===b-1&&v.addClass("last"),s.is(":disabled")||r?(h=n("<span>",{text:s.text()}).addClass(e.settings.classDisabled),i&&h.addClass(e.settings.classSub),h.appendTo(v)):(h=n("<a>",{href:"#"+s.val(),rel:s.val()}).text(s.text()).bind("click.sb",function(i){i&&i.preventDefault&&i.preventDefault();var u=a,r=n(this),f=u.attr("id").split("_")[1];o._changeSelectbox(t,r.attr("rel"),r.text()),o._closeSelectbox(t)}).bind("mouseover.sb",function(){var t=n(this);t.parent().siblings().find("a").removeClass(e.settings.classFocus),t.addClass(e.settings.classFocus)}).bind("mouseout.sb",function(){n(this).removeClass(e.settings.classFocus)}),i&&h.addClass(e.settings.classSub),s.is(":selected")&&h.addClass(e.settings.classFocus),h.appendTo(v)),v.appendTo(c)})}if(this._getInst(t))return i;var s=n(t),o=this,e=o._newInst(s),h,l,a,c,w=i,k=s.find("optgroup"),p=s.find("option"),b=p.length;s.attr("sb",e.uid),n.extend(e.settings,o._defaults,f),o._state[e.uid]=i,s.hide(),h=n("<div>",{id:"sbHolder_"+e.uid,"class":e.settings.classHolder,tabindex:s.attr("tabindex")}),l=n("<a>",{id:"sbSelector_"+e.uid,href:"#","class":e.settings.classSelector,click:function(i){i.preventDefault(),v.apply(n(this),[]);var r=n(this).attr("id").split("_")[1];o._state[r]?o._closeSelectbox(t):o._openSelectbox(t)}}),a=n("<a>",{id:"sbToggle_"+e.uid,href:"#","class":e.settings.classToggle,click:function(i){i.preventDefault(),v.apply(n(this),[]);var r=n(this).attr("id").split("_")[1];o._state[r]?o._closeSelectbox(t):o._openSelectbox(t)}}),a.appendTo(h),c=n("<ul>",{id:"sbOptions_"+e.uid,"class":e.settings.classOptions,css:{display:"none"}}),s.children().each(function(){var i=n(this),u,r={};i.is("option")?y(i):i.is("optgroup")&&(u=n("<li>"),n("<span>",{text:i.attr("label")}).addClass(e.settings.classGroup).appendTo(u),u.appendTo(c),i.is(":disabled")&&(r.disabled=!0),r.sub=!0,y(i.find("option"),r))}),w||l.text(p.first().text()),n.data(t,r,e),h.data("uid",e.uid).bind("keydown.sb",function(t){var l=t.charCode?t.charCode:t.keyCode?t.keyCode:0,f=n(this),c=f.data("uid"),s=f.siblings("select[sb='"+c+"']").data(r),e=f.siblings(["select[sb='",c,"']"].join("")).get(0),i=f.find("ul").find("a."+s.settings.classFocus),u,h;switch(l){case 37:case 38:i.length>0&&(n("a",f).removeClass(s.settings.classFocus),u=i.parent().prevAll("li:has(a)").eq(0).find("a"),u.length>0&&(u.addClass(s.settings.classFocus).focus(),n("#sbSelector_"+c).text(u.text())));break;case 39:case 40:n("a",f).removeClass(s.settings.classFocus),u=i.length>0?i.parent().nextAll("li:has(a)").eq(0).find("a"):f.find("ul").find("a").eq(0),u.length>0&&(u.addClass(s.settings.classFocus).focus(),n("#sbSelector_"+c).text(u.text()));break;case 13:i.length>0&&o._changeSelectbox(e,i.attr("rel"),i.text()),o._closeSelectbox(e);break;case 9:e&&(s=o._getInst(e),s&&(i.length>0&&o._changeSelectbox(e,i.attr("rel"),i.text()),o._closeSelectbox(e))),h=parseInt(f.attr("tabindex"),10),t.shiftKey?h--:h++,n("*[tabindex='"+h+"']").focus();break;case 27:o._closeSelectbox(e)}return t.stopPropagation(),!1}).delegate("a","mouseover",function(){n(this).addClass(e.settings.classFocus)}).delegate("a","mouseout",function(){n(this).removeClass(e.settings.classFocus)}),l.appendTo(h),c.appendTo(h),h.insertAfter(s),n("html").live("mousedown",function(t){t.stopPropagation(),n("select").selectbox("close")}),n([".",e.settings.classHolder,", .",e.settings.classSelector].join("")).mousedown(function(n){n.stopPropagation()})},_detachSelectbox:function(t){var u=this._getInst(t);if(!u)return i;n("#sbHolder_"+u.uid).remove(),n.data(t,r,null),n(t).show()},_changeSelectbox:function(t,i,r){var e,f=this._getInst(t);f&&(e=this._get(f,"onChange"),n("#sbSelector_"+f.uid).text(r)),i=i.replace(/\'/g,"\\'"),n(t).find("option[value='"+i+"']").attr("selected",u),f&&e?e.apply(f.input?f.input[0]:null,[i,f]):f&&f.input&&f.input.trigger("change")},_enableSelectbox:function(t){var u=this._getInst(t);if(!u||!u.isDisabled)return i;n("#sbHolder_"+u.uid).removeClass(u.settings.classHolderDisabled),u.isDisabled=i,n.data(t,r,u)},_disableSelectbox:function(t){var f=this._getInst(t);if(!f||f.isDisabled)return i;n("#sbHolder_"+f.uid).addClass(f.settings.classHolderDisabled),f.isDisabled=u,n.data(t,r,f)},_optionSelectbox:function(t,u,f){var e=this._getInst(t);if(!e)return i;e[u]=f,n.data(t,r,e)},_openSelectbox:function(t){var i=this._getInst(t);if(i&&!i.isOpen&&!i.isDisabled){var f=n("#sbOptions_"+i.uid),l=parseInt(n(window).height(),10),h=n("#sbHolder_"+i.uid).offset(),c=n(window).scrollTop(),e=f.prev().height(),s=l-(h.top-c)-e/2,o=this._get(i,"onOpen");f.css({top:e+"px",maxHeight:s-e+"px"}),i.settings.effect==="fade"?f.fadeIn(i.settings.speed):f.slideDown(i.settings.speed),n("#sbToggle_"+i.uid).addClass(i.settings.classToggleOpen),this._state[i.uid]=u,i.isOpen=u,o&&o.apply(i.input?i.input[0]:null,[i]),n.data(t,r,i)}},_closeSelectbox:function(t){var u=this._getInst(t),f;u&&u.isOpen&&(f=this._get(u,"onClose"),u.settings.effect==="fade"?n("#sbOptions_"+u.uid).fadeOut(u.settings.speed):n("#sbOptions_"+u.uid).slideUp(u.settings.speed),n("#sbToggle_"+u.uid).removeClass(u.settings.classToggleOpen),this._state[u.uid]=i,u.isOpen=i,f&&f.apply(u.input?u.input[0]:null,[u]),n.data(t,r,u))},_newInst:function(n){var t=n[0].id.replace(/([^A-Za-z0-9_-])/g,"\\\\$1");return{id:t,input:n,uid:Math.floor(Math.random()*99999999),isOpen:i,isDisabled:i,settings:{}}},_getInst:function(t){try{return n.data(t,r)}catch(i){throw"Missing instance data for this selectbox";}},_get:function(n,i){return n.settings[i]!==t?n.settings[i]:this._defaults[i]}}),n.fn.selectbox=function(t){var i=Array.prototype.slice.call(arguments,1);return typeof t=="string"&&t=="isDisabled"?n.selectbox["_"+t+"Selectbox"].apply(n.selectbox,[this[0]].concat(i)):t=="option"&&arguments.length==2&&typeof arguments[1]=="string"?n.selectbox["_"+t+"Selectbox"].apply(n.selectbox,[this[0]].concat(i)):this.each(function(){typeof t=="string"?n.selectbox["_"+t+"Selectbox"].apply(n.selectbox,[this].concat(i)):n.selectbox._attachSelectbox(this,t)})},n.selectbox=new f,n.selectbox.version="0.2"})(jQuery)